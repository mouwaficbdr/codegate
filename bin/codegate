#!/bin/bash
# CodeGate CLI - Contr√¥le du daemon CodeGate
# Usage: codegate {open|config|quit|status}

set -e

# D√©terminer le chemin du socket
SOCKET_DIR="${XDG_RUNTIME_DIR:-$HOME/.cache/codegate}"
SOCKET_PATH="$SOCKET_DIR/codegate.sock"

# Fonction pour envoyer une commande au daemon
send_command() {
    local command="$1"
    
    if [ ! -S "$SOCKET_PATH" ]; then
        echo "‚ùå Erreur: CodeGate n'est pas en cours d'ex√©cution"
        echo "üí° D√©marrez-le avec: $HOME/.local/share/codegate/run_codegate.sh"
        exit 1
    fi
    
    # Envoyer la commande et afficher la r√©ponse
    response=$(echo "$command" | nc -U "$SOCKET_PATH" 2>/dev/null || echo '{"status":"error","message":"Connection failed"}')
    
    # Parser la r√©ponse JSON (simple)
    if echo "$response" | grep -q '"status":"ok"'; then
        echo "‚úì Commande ex√©cut√©e avec succ√®s"
        echo "$response" | grep -oP '"message":"\K[^"]+' || true
    else
        echo "‚ùå Erreur lors de l'ex√©cution"
        echo "$response" | grep -oP '"message":"\K[^"]+' || echo "$response"
        exit 1
    fi
}

# Parser les arguments
case "${1:-}" in
    open|config|dashboard)
        send_command "SHOW_DASHBOARD"
        ;;
    quit|stop)
        send_command "QUIT"
        ;;
    status)
        send_command "STATUS"
        ;;
    help|--help|-h)
        cat << EOF
CodeGate CLI - Contr√¥le du daemon CodeGate

Usage: codegate <commande>

Commandes disponibles:
  open, config, dashboard    Ouvrir le tableau de bord
  quit, stop                 Arr√™ter CodeGate
  status                     Afficher le statut
  help                       Afficher cette aide

Exemples:
  codegate open              # Ouvrir le dashboard
  codegate status            # V√©rifier si CodeGate tourne
  codegate quit              # Arr√™ter CodeGate

EOF
        ;;
    "")
        echo "‚ùå Erreur: Aucune commande sp√©cifi√©e"
        echo "üí° Utilisez 'codegate help' pour voir les commandes disponibles"
        exit 1
        ;;
    *)
        echo "‚ùå Erreur: Commande inconnue '$1'"
        echo "üí° Utilisez 'codegate help' pour voir les commandes disponibles"
        exit 1
        ;;
esac
